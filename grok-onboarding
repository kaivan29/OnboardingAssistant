#!/bin/bash

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# ASCII Art
print_banner() {
    echo -e "${CYAN}"
    echo "   ______           __    ____      __                         ___            "
    echo "  / ____/________  / /__ / __ \____/ /_  ____  ____ __________/ (_)___  ____ _"
    echo " / / __/ ___/ __ \/ //_// / / / __  / / / / / / / // / ___/ _  / / __ \/ __ \`/"
    echo "/ /_/ / /  / /_/ / ,<  / /_/ / /_/ / /_/ / /_/ / // / /  / // / / / / / /_/ / "
    echo "\____/_/   \____/_/|_| \____/\__,_/\__,_/\__,_/\_,_/_/   \__,_/_/_/ /_/\__, / "
    echo "                                                                      /____/  "
    echo -e "${NC}"
}

# Loading effect
spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

print_banner



APP_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Helper to check if a port is open
check_port() {
    lsof -i :$1 >/dev/null 2>&1
}

wait_for_service() {
    local port=$1
    local name=$2
    local max_retries=30
    local count=0

    echo -n "Waiting for $name to be ready..."
    while ! check_port $port; do
        sleep 1
        count=$((count + 1))
        if [ $count -ge $max_retries ]; then
            echo -e " ${RED}[FAILED]${NC}"
            echo -e "${RED}[ERROR]${NC} $name failed to start on port $port."
            exit 1
        fi
    done
    echo -e " ${GREEN}[OK]${NC}"
}

start_servers() {
    echo -e "${BLUE}[SYS]${NC} Checking system services..."

    # Check Backend
    if check_port 8000; then
        echo -e "${GREEN}[OK]${NC} Backend operational (Port 8000)."
    else
        echo -e "${YELLOW}[INIT]${NC} Starting Backend Neural Core..."
        cd "$APP_ROOT/backend" || exit 1
        
        if [ ! -f ".env" ]; then
            echo -e "${RED}[ERROR]${NC} Configuration matrix (.env) missing in backend."
            echo -e "${YELLOW}[HINT]${NC} Copy .env.example to .env and configure authentication tokens."
            exit 1
        fi

        if [ -f "venv/bin/uvicorn" ]; then
            # Run using direct path to venv binary
            nohup ./venv/bin/uvicorn main:app --reload --port 8000 > "$APP_ROOT/backend/server.log" 2>&1 &
        else 
            echo -e "${RED}[ERROR]${NC} Neural Core executable (uvicorn) not found in venv."
            exit 1
        fi
        
        wait_for_service 8000 "Backend"
    fi

    # Check Frontend
    if check_port 3000; then
        echo -e "${GREEN}[OK]${NC} Frontend operational (Port 3000)."
    else
        echo -e "${YELLOW}[INIT]${NC} Starting Frontend Interface..."
        cd "$APP_ROOT/client" || exit 1
        # Run in background
        nohup npm run dev > "$APP_ROOT/client/client.log" 2>&1 &
        wait_for_service 3000 "Frontend"
    fi
}

start_servers

PROJECT=$1
XHACK_DIR="$HOME/xHack"

if [ -z "$PROJECT" ]; then
  echo -e "${RED}[ERROR]${NC} Target sequence definition missing."
  echo -e "Usage: ${BOLD}grok-onboarding <project_identifier>${NC}"
  exit 1
fi

# Simple mapping via pseudo-db
if [ "$PROJECT" == "rocksdb" ]; then
  REPO_URL="https://github.com/facebook/rocksdb.git"
else
  echo -e "${RED}[FATAL]${NC} Project signature '${PROJECT}' not found in local registry."
  echo -e "${YELLOW}[HINT]${NC} Only 'rocksdb' protocol is currently authorized."
  exit 1
fi

echo -e "${BLUE}[INIT]${NC} Initializing neural link to ${BOLD}$PROJECT${NC}..."
sleep 0.5

echo -e "${BLUE}[SYS]${NC} Verifying workspace integrity at ${CYAN}$XHACK_DIR${NC}..."
mkdir -p "$XHACK_DIR"
cd "$XHACK_DIR" || exit 1

if [ -d "$PROJECT" ]; then
    echo -e "${GREEN}[OK]${NC} Local cache found. Skipping quantum replication."
else
    echo -e "${YELLOW}[NET]${NC} Establishing downlink from ${REPO_URL}..."
    git clone "$REPO_URL" &
    spinner $!
    echo -e "${GREEN}[SUCCESS]${NC} Codebase extraction complete."
fi

# Simulate processing
echo -n "Analyzing vector compatibility..."
sleep 0.5
echo -e " ${GREEN}[OK]${NC}"

# Open the app
URL="http://localhost:3000?codebase=$PROJECT"
echo -e "${BLUE}[LAUNCH]${NC} Engaging visualization interface..."
open "$URL"

echo -e "\n${BOLD}>> SYSTEM READY. GOOD LUCK, RECRUIT.${NC}\n"
